<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>POWER SHUTDOWN MANAGEMENT APP - AREA-IV</title>

<style>
body{font-family:Segoe UI,Arial;background:#f1f3f6;margin:0}
header{background:#1f3a5f;color:#fff;padding:14px;font-size:18px;font-weight:700;text-align:center}
.container{padding:16px;max-width:480px;margin:auto}
.hidden{display:none}
input,select,textarea,button{
 width:100%;padding:12px;margin-top:10px;
 border-radius:10px;border:1px solid #ccc;font-size:15px
}
button{border:none;font-weight:700;cursor:pointer}
.btn-login{background:#1f3a5f;color:#fff}
.btn-shutdown{background:#e74c3c;color:#fff}
.btn-resume{background:#27ae60;color:#fff}
.card{background:#fff;padding:16px;border-radius:14px;margin-bottom:14px}
#msg{text-align:center;font-weight:700;margin-top:10px}
.shutdown-item{border:1px solid #ddd;padding:12px;border-radius:12px;margin-bottom:10px}
.whatsapp{background:#25D366;color:#fff;margin-top:8px}
</style>
</head>

<body>
<header>POWER SHUTDOWN MANAGEMENT APP â€“ AREA-IV</header>

<div class="container">

<!-- LOGIN -->
<div class="card" id="loginBox">
<h3 style="text-align:center">USER LOGIN</h3>
<input id="loginUser" placeholder="Username">
<input id="loginPass" type="password" placeholder="Password">
<button class="btn-login" onclick="login()">Login</button>
</div>

<!-- MAIN -->
<div class="card hidden" id="mainBox">
<h3>ACTIVE SHUTDOWNS</h3>
<div id="activeShutdowns">Loadingâ€¦</div>
<button class="btn-shutdown" onclick="openShutdown()">Shutdown</button>
<button class="btn-resume" onclick="openResume()">Resume</button>
</div>

<!-- SHUTDOWN -->
<div class="card hidden" id="shutdownBox">
<h3>Shutdown Entry</h3>
<select id="sd_feeder"></select>
<input type="datetime-local" id="sd_time">
<select id="sd_type">
<option value="">Select Type</option>
<option>PLAN PSD</option>
<option>UNPLAN PSD</option>
</select>
<textarea id="sd_info" placeholder="Information"></textarea>
<button class="btn-shutdown" onclick="submitShutdown()">Submit</button>
<button onclick="backToMain()">Back</button>
</div>

<!-- RESUME -->
<div class="card hidden" id="resumeBox">
<h3>Resume Entry</h3>
<select id="rs_feeder"></select>
<input type="datetime-local" id="rs_time">
<input id="rs_loss" placeholder="Production Loss">
<input id="rs_dg" placeholder="DG Deployed">
<textarea id="rs_rem" placeholder="Actual Reason"></textarea>
<button class="btn-resume" onclick="submitResume()">Submit</button>
<button class="whatsapp hidden" id="resumeShareBtn" onclick="shareResume()">ðŸ“² Share Resume</button>
<button onclick="backToMain()">Back</button>
</div>

<div id="msg"></div>
</div>

<script>
const WEBAPP_URL="https://script.google.com/macros/s/AKfycbyx7kSp2pxjpS3X3155p4K5bUq92dLE-EfXnee6ZyR6WgnLwUoidwLfW06d1aZffjs6XA/exec";
const CSV_URL="https://docs.google.com/spreadsheets/d/1NLMcoIjlo5elmrALUXPfvGOEqToS8tFPfGThRZ8maiU/export?format=csv";

const USERS=[{u:"121318",p:"admin123",n:"ADMIN",i:"ALL",admin:true}];
const FEEDERS={ALL:["AKASH CERAMIC FEEDER","ITLA ONGC FEEDER-LG1"]};

let CURRENT_USER={}, LAST_SHUTDOWN={}, LAST_RESUME=null;

function login(){
 const u=USERS.find(x=>x.u===loginUser.value && x.p===loginPass.value);
 if(!u){msg("âŒ Invalid login");return;}
 CURRENT_USER=u;
 loginBox.classList.add("hidden");
 mainBox.classList.remove("hidden");
 populateFeeders();
 loadActive();
}

function populateFeeders(){
 sd_feeder.innerHTML=rs_feeder.innerHTML="";
 FEEDERS.ALL.forEach(f=>{
  sd_feeder.innerHTML+=`<option>${f}</option>`;
  rs_feeder.innerHTML+=`<option>${f}</option>`;
 });
}

function loadActive(){
 fetch(CSV_URL+"&t="+Date.now())
 .then(r=>r.text())
 .then(t=>{
  activeShutdowns.innerHTML="";
  LAST_SHUTDOWN={};
  t.split("\n").slice(1).forEach(r=>{
   const c=r.split(",");
   if(c.length < 2) return;   // âœ… FIX
   const feeder=c[0], sd=c[1], resume=c[6]||"";
   if(!resume){
    LAST_SHUTDOWN[feeder]=sd;
    activeShutdowns.innerHTML+=`
      <div class="shutdown-item">
        <b>${feeder}</b><br>${sd}
        <button class="whatsapp"
          onclick="shareShutdown('${feeder}','${sd}')">
          ðŸ“² Share Shutdown
        </button>
      </div>`;
   }
  });
 });
}

function submitShutdown(){
 fetch(WEBAPP_URL+"?"+new URLSearchParams({
  action:"shutdown",
  feeder:sd_feeder.value,
  ShutdownTime:sd_time.value.replace("T"," "),
  ShutdownType:sd_type.value,
  Information:sd_info.value,
  ShutdownEntryBy:CURRENT_USER.n,
  Installation:CURRENT_USER.i
 }));
 msg("âœ… Shutdown submitted");
 backToMain();
}

function submitResume(){
 LAST_RESUME={
  feeder:rs_feeder.value,
  time:rs_time.value.replace("T"," "),
  loss:rs_loss.value,
  dg:rs_dg.value,
  rem:rs_rem.value
 };
 fetch(WEBAPP_URL+"?"+new URLSearchParams({
  action:"resume",
  feeder:LAST_RESUME.feeder,
  ResumeTime:LAST_RESUME.time,
  ResumeEntryBy:CURRENT_USER.n,
  TotalProdLoss:LAST_RESUME.loss,
  DGDeployed:LAST_RESUME.dg,
  Remarks:LAST_RESUME.rem
 }));
 document.getElementById("resumeShareBtn").classList.remove("hidden");
 msg("âœ… Resume submitted");
}

function shareShutdown(f,t){
 window.open("https://wa.me/?text="+encodeURIComponent(
  "âš¡ POWER SHUTDOWN\n\nFeeder: "+f+"\nTime: "+t
 ));
}
function shareResume(){
 const d=LAST_RESUME;
 window.open("https://wa.me/?text="+encodeURIComponent(
  "âœ… POWER RESUME\n\nFeeder: "+d.feeder+"\nTime: "+d.time+
  "\nLoss: "+d.loss+"\nDG: "+d.dg+"\nReason: "+d.rem
 ));
}

function openShutdown(){mainBox.classList.add("hidden");shutdownBox.classList.remove("hidden")}
function openResume(){mainBox.classList.add("hidden");resumeBox.classList.remove("hidden")}
function backToMain(){
 shutdownBox.classList.add("hidden");
 resumeBox.classList.add("hidden");
 mainBox.classList.remove("hidden");
 loadActive();
}
function msg(t){document.getElementById("msg").innerText=t}
</script>
</body>
</html>
