<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>POWER SHUTDOWN MANAGEMENT APP - AREA-IV</title>

<style>
body{font-family:Segoe UI,Arial;background:#f1f3f6;margin:0}
header{background:#1f3a5f;color:#fff;padding:14px;text-align:center;font-weight:600}
.container{padding:16px;max-width:480px;margin:auto}
.card{margin-bottom:20px}
h2,h3{text-align:center;color:#1f3a5f}
input,select,textarea{
 width:100%;padding:12px;margin-top:6px;
 border-radius:10px;border:1px solid #ccc;font-size:15px}
button{
 width:100%;padding:14px;margin-top:14px;
 border:none;border-radius:14px;font-size:16px;font-weight:600;cursor:pointer}
.btn-login{background:#1f3a5f;color:#fff}
.btn-shutdown{background:#e74c3c;color:#fff}
.btn-resume{background:#27ae60;color:#fff}
.btn-back{background:#7f8c8d;color:#fff}
.hidden{display:none}
.shutdown-item{
 background:#fff;padding:16px;border-radius:14px;
 margin-bottom:12px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
.shutdown-row{display:flex;justify-content:space-between;font-size:14px;margin-bottom:6px}
.shutdown-label{color:#777;font-weight:600}
.shutdown-value{font-weight:700}
.install-badge{
 background:#e5f0ff;color:#1f3a5f;
 padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
#msg{text-align:center;font-weight:700;margin-top:10px}
</style>
</head>

<body>
<header>POWER SHUTDOWN MANAGEMENT APP - AREA-IV</header>

<div id="userInfo" class="hidden" style="background:#fff;margin:10px;padding:10px;border-radius:12px;text-align:center">
 <div id="ui_name" style="font-weight:700"></div>
 <div id="ui_inst" style="font-size:13px;color:#666"></div>
</div>

<div class="container">

<!-- LOGIN -->
<div class="card" id="loginBox">
<h3>USER LOGIN</h3>
<input id="loginUser" placeholder="Username">
<input id="loginPass" type="password" placeholder="Password">
<button class="btn-login" onclick="login()">Login</button>
</div>

<!-- MAIN -->
<div class="card hidden" id="mainBox">
<h2>ACTIVE SHUTDOWNS</h2>
<div id="activeShutdowns">Loading...</div>
<button class="btn-shutdown" onclick="openShutdown()">Shutdown</button>
<button class="btn-resume" onclick="openResume()">Resume</button>
</div>

<!-- SHUTDOWN -->
<div class="card hidden" id="shutdownBox">
<h3>Shutdown Entry</h3>
<select id="sd_feeder"></select>
<input type="datetime-local" id="sd_time">
<select id="sd_type">
<option value="">Select Type</option>
<option>PLAN PSD</option>
<option>UNPLAN PSD</option>
</select>
<textarea id="sd_info" placeholder="Information"></textarea>
<button class="btn-shutdown" onclick="submitShutdown()">Submit</button>
<button class="btn-back" onclick="backToMain()">Back</button>
</div>

<!-- RESUME -->
<div class="card hidden" id="resumeBox">
<h3>Resume Entry</h3>
<select id="rs_feeder"></select>
<input type="datetime-local" id="rs_time">
<input id="rs_loss" type="number" placeholder="Production Loss">
<input id="rs_dg" type="number" placeholder="DG Deployed">
<textarea id="rs_rem" placeholder="Actual Reason"></textarea>
<button class="btn-resume" onclick="submitResume()">Submit</button>
<button id="resumeShareBtn" class="btn-resume hidden" onclick="shareResumeWhatsApp()">ðŸ“² Share WhatsApp</button>
<button class="btn-back" onclick="backToMain()">Back</button>
</div>

<div id="msg"></div>
</div>

<script>
/* ================= CONFIG ================= */
const WEBAPP_URL="https://script.google.com/macros/s/AKfycbz1g6vziMziteLRvxrVRtVr-xUOFdLrpDN4OqoiaDEv-c2h1-fUHk9nq2LueN4XuHHsKQ/exec";
const CSV_URL="https://docs.google.com/spreadsheets/d/12Vb60sr_ApZ6JBpE2D_nZweJhTk7DLDEf9XHfpIbJzQ/export?format=csv";

/* ================= USERS ================= */
const USERS=[
 {u:"121318",p:"admin123",n:"SYSTEM ADMIN",i:"ALL",admin:true},
 {u:"130594",p:"1234",n:"MAHESH GAJJAR",i:"MOTERA-GGS"}
];

/* ================= FEEDERS ================= */
const FEEDERS={
 "MOTERA-GGS":["TP-44 FEEDER","ZUNDAL AG FEEDER"],
 "ALL":["TP-44 FEEDER","ZUNDAL AG FEEDER"]
};

let CURRENT_USER={},LAST_SHUTDOWN_TIME={},LAST_RESUME_DATA=null;

/* ================= HELPERS ================= */
function showMsg(t){msg.innerText=t;setTimeout(()=>msg.innerText="",3000);}
function hasSpecialChar(t){return !/^[a-zA-Z0-9 \-/]+$/.test(t);}

/* ================= LOGIN ================= */
function login(){
 const u=USERS.find(x=>x.u===loginUser.value && x.p===loginPass.value);
 if(!u){showMsg("Invalid Login");return;}
 CURRENT_USER=u;
 ui_name.innerText="ðŸ‘¤ "+u.n;
 ui_inst.innerText="Installation : "+u.i;
 userInfo.classList.remove("hidden");
 loginBox.classList.add("hidden");
 mainBox.classList.remove("hidden");
 populateFeeders();
 loadActiveShutdowns();
}

/* ================= FEEDER LOAD ================= */
function populateFeeders(){
 sd_feeder.innerHTML=rs_feeder.innerHTML="";
 (FEEDERS[CURRENT_USER.i]||FEEDERS.ALL).forEach(f=>{
  sd_feeder.innerHTML+=`<option>${f}</option>`;
  rs_feeder.innerHTML+=`<option>${f}</option>`;
 });
}

/* ================= ACTIVE SHUTDOWN ================= */
function loadActiveShutdowns(){
 LAST_SHUTDOWN_TIME={};
 fetch(CSV_URL+"&t="+Date.now())
 .then(r=>r.text())
 .then(t=>{
  activeShutdowns.innerHTML="";
  t.split("\n").slice(1).forEach(r=>{
   const c=r.split(",");
   if(!c[2]){
    LAST_SHUTDOWN_TIME[c[0]]=c[1];
    activeShutdowns.innerHTML+=`
    <div class="shutdown-item">
     <div class="shutdown-row"><span class="shutdown-label">Feeder</span><span class="shutdown-value">${c[0]}</span></div>
     <div class="shutdown-row"><span class="shutdown-label">Time</span><span class="shutdown-value">${c[1]}</span></div>
    </div>`;
   }
  });
 });
}

/* ================= SUBMIT SHUTDOWN ================= */
function submitShutdown(){
 if(!sd_feeder.value||!sd_time.value||!sd_type.value||!sd_info.value){
  showMsg("All fields required");return;}
 if(hasSpecialChar(sd_info.value)){showMsg("No special chars");return;}

 fetch(WEBAPP_URL+"?"+new URLSearchParams({
  action:"shutdown",
  feeder:sd_feeder.value,
  ShutdownTime:sd_time.value.replace("T"," "),
  ShutdownType:sd_type.value,
  Information:sd_info.value,
  ShutdownEntryBy:CURRENT_USER.n,
  Installation:CURRENT_USER.i
 }),{mode:"no-cors"});

 showMsg("Shutdown Submitted");
 backToMain();
}

/* ================= SUBMIT RESUME ================= */
function submitResume(){
 if(!rs_feeder.value||!rs_time.value){showMsg("All fields required");return;}
 fetch(WEBAPP_URL+"?"+new URLSearchParams({
  action:"resume",
  feeder:rs_feeder.value,
  ResumeTime:rs_time.value.replace("T"," "),
  ResumeEntryBy:CURRENT_USER.n,
  TotalProdLoss:rs_loss.value,
  DGDeployed:rs_dg.value,
  Remarks:rs_rem.value
 }),{mode:"no-cors"});
 showMsg("Resume Submitted");
}

/* ================= NAV ================= */
function openShutdown(){mainBox.classList.add("hidden");shutdownBox.classList.remove("hidden")}
function openResume(){mainBox.classList.add("hidden");resumeBox.classList.remove("hidden")}
function backToMain(){shutdownBox.classList.add("hidden");resumeBox.classList.add("hidden");mainBox.classList.remove("hidden");loadActiveShutdowns()}
</script>

</body>
</html>
