<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>POWER SHUTDOWN MANAGEMENT APP - AREA-IV</title>

<style>
body{
  font-family:"Segoe UI",Roboto,Arial;
  background:#f1f3f6;
  margin:0;
}
header{
  background:#1f3a5f;
  color:#fff;
  padding:14px 18px;
  font-size:18px;
  font-weight:600;
}
.card{
  background:#fff;
  margin:14px;
  padding:16px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}
.hidden{display:none;}
input,select,textarea{
  width:100%;
  padding:8px;
  margin:6px 0;
  border-radius:4px;
  border:1px solid #ccc;
  font-size:14px;
}
button{
  padding:10px 14px;
  border:none;
  border-radius:5px;
  cursor:pointer;
  font-weight:600;
  margin-top:8px;
}
.btn-login{background:#1f3a5f;color:#fff;width:100%;}
.btn-shutdown{background:#c0392b;color:#fff;}
.btn-resume{background:#27ae60;color:#fff;}
.btn-back{background:#7f8c8d;color:#fff;}
.msg{margin-top:8px;font-weight:600;}
.list{margin-top:8px;font-size:14px;}
.list div{padding:6px;border-bottom:1px solid #ddd;}
</style>
</head>

<body>

<header>POWER SHUTDOWN MANAGEMENT APP - AREA-IV</header>

<!-- LOGIN -->
<div class="card" id="loginBox">
  <h3>Login</h3>
  <input id="lg_user" placeholder="Username">
  <input id="lg_pass" type="password" placeholder="Password">
  <button class="btn-login" onclick="login()">LOGIN</button>
  <div class="msg" id="loginMsg"></div>
</div>

<!-- MAIN -->
<div class="card hidden" id="mainBox">
  <h3 id="welcome"></h3>
  <button class="btn-shutdown" onclick="openShutdown()">Shutdown Entry</button>
  <button class="btn-resume" onclick="openResume()">Resume Entry</button>
  <button class="btn-login hidden" id="planBtn">Plan Shutdown (ADMIN)</button>

  <h4>Active Shutdowns</h4>
  <div class="list" id="activeList"></div>
</div>

<!-- SHUTDOWN -->
<div class="card hidden" id="shutdownBox">
  <h3>Shutdown Entry</h3>
  <select id="sd_feeder"></select>
  <input type="datetime-local" id="sd_time">
  <select id="sd_type">
    <option>UNPLAN</option>
    <option>PLAN</option>
  </select>
  <textarea id="sd_info" placeholder="Information"></textarea>
  <button class="btn-shutdown" onclick="submitShutdown()">Submit Shutdown</button>
  <button class="btn-back" onclick="back()">Back</button>
  <div class="msg" id="sd_msg"></div>
</div>

<!-- RESUME -->
<div class="card hidden" id="resumeBox">
  <h3>Resume Entry</h3>
  <select id="rs_feeder"></select>
  <input type="datetime-local" id="rs_time">
  <input id="rs_loss" placeholder="Production Loss">
  <input id="rs_dg" placeholder="DG Deployed">
  <textarea id="rs_rem" placeholder="Remarks"></textarea>
  <button class="btn-resume" onclick="submitResume()">Submit Resume</button>
  <button id="resumeShareBtn" class="btn-resume hidden"
    onclick="shareResumeWhatsApp()">ðŸ“² Share Resume</button>
  <button class="btn-back" onclick="back()">Back</button>
  <div class="msg" id="rs_msg"></div>
</div>

<script>
/* ================= CONFIG ================= */
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbyOHQzRGiI0ql-Tlzbm9BhtFfE12YXEIy9TCfP1_uzdtbn4ltTcjBWJwnpWOF1-u08tkA/exec";
const CSV_URL="https://docs.google.com/spreadsheets/d/1NLMcoIjlo5elmrALUXPfvGOEqToS8tFPfGThRZ8maiU/export?format=csv";
const USERS=[
 {u:"121318",p:"admin123",n:"SYSTEM ADMIN",i:"ALL",admin:true},
 {u:"95606",p:"*ongc123",n:"SUDHIR SINGH",i:"ALL",admin:true},
 {u:"95843",p:"*ongc123",n:"DIPAK MEDAK",i:"ALL",admin:true},
 {u:"82653",p:"*ongc123",n:"SHANTILAL RATHWA",i:"ALL",admin:true},
 {u:"82051",p:"*ongc123",n:"HEMENDRA KUMAR",i:"ALL",admin:true},
 {u:"124569",p:"1234",n:"KULDIP KHAROLIA",i:"LIMBODARA-GGS-1"},
 {u:"133668",p:"1234",n:"DIPAK MAURYA",i:"LIMBODARA-GGS-1"},
 {u:"124470",p:"1234",n:"SANDESH BHARDWAJ",i:"LIMBODARA-GGS-2"},
 {u:"135597",p:"1234",n:"KUNAL RANJAN",i:"LIMBODARA-GGS-2"},
 {u:"139938",p:"1234",n:"HAREKRISHNA",i:"LIMBODARA-GGS-2"},
 {u:"125223",p:"1234",n:"SUKUMAR LAHA",i:"GAMIJ-GGS-1"},
 {u:"139646",p:"1234",n:"RAVI KUMAR SHARMA",i:"GAMIJ-GGS-1"},
 {u:"137317",p:"1234",n:"SONUKUMAR SINGH",i:"GAMIJ-GGS-1"},
 {u:"121028",p:"1234",n:"ABHISHEK PATEL",i:"GAMIJ-GGS-2"},
 {u:"133181",p:"1234",n:"KETUL PATEL",i:"GAMIJ-GGS-2"},
 {u:"123310",p:"1234",n:"DHEERENDRA SINGH",i:"GAMIJ-GGS-3"},
 {u:"133643",p:"1234",n:"ASHUTOSH KUMAR SINGH",i:"GAMIJ-GGS-3"},
 {u:"135515",p:"1234",n:"ADITYA ARYA",i:"GAMIJ-GGS-3"},
 {u:"130594",p:"1234",n:"MAHESH GAJJAR",i:"MOTERA-GGS"}
];

const FEEDERS={
 "LIMBODARA-GGS-1":["AKASH CERAMIC FEEDER","ITLA ONGC FEEDER-LG1","MANSA CITY FEEDER","MANSA CIVIL FEEDER"],
"LIMBODARA-GGS-2":["ITLA ONGC FEEDER-LG2","KIRTIDHAM FEEDER","LISA FEEDER","MAHAKALI FEEDER","MUBARAKPUR FEEDER","NETRA FEEDER","ROYAL FEEDER","TIRUPATI FEEDER","VARDAYINI FEEDER"],
"GAMIJ-GGS-1":["BAHIYAL ONGC FEEDER","RAM FEEDER-GAMIJ-1","SOMNATH JGY FEEDER","NAYRA JGY FEEDER","VASNA RATHOD FEEDER"],
"GAMIJ-GGS-2":["BADARPUR FEEDER","CHAULAJ FEEDER-GAMIJ-2","GADWEL FEEDER","KASHTABHANJAN FEEDER","RAM FEEDR-GAMIJ-2"],
"GAMIJ-GGS-3":["BADARPUR FEEDER","CHAULAJ FFEDER-GAMIJ-2","GADWEL FEEDER","KASHTABHANJAN FEEDER","RAM FEEDR-GAMIJ-2","BARMUVADA FEEDER","CHAULAJ FEEDER-GAMIJ-3","FINAV FEEEDER","FUDAL MATA FEEDER","GAYATRI FEEDER","GINJAR FEEDER","HALDARWAS FEEDER-GAMIJ-3","HALDARWAS FEEDER-GAMIJ-4","KALPSAR FEEDER","SATRUNDA FEEDER-GAMIJ-3","SATRUNDA FEEDER-GAMIJ-4","SIHUNJ FEEDER","VANSOLI FEEDER"],
"MOTERA-GGS":["PREKSHA BHARTI INFOCITY FEEDER","TP-44 FEEDER","ZUNDAL AG FEEDER"],
"ALL":["AKASH CERAMIC FEEDER","ITLA ONGC FEEDER-LG1","MANSA CITY FEEDER","MANSA CIVIL FEEDER",
 "ITLA ONGC FEEDER-LG2","KIRTIDHAM FEEDER","LISA FEEDER","MAHAKALI FEEDER",
 "MUBARAKPUR FEEDER","NETRA FEEDER","ROYAL FEEDER","TIRUPATI FEEDER","VARDAYINI FEEDER",
 "BAHIYAL ONGC FEEDER","RAM FEEDER-GAMIJ-1","SOMNATH JGY FEEDER","NAYRA JGY FEEDER",
 "VASNA RATHOD FEEDER","BADARPUR FEEDER","CHAULAJ FFEDER-GAMIJ-2","GADWEL FEEDER",
 "KASHTABHANJAN FEEDER","RAM FEEDR-GAMIJ-2","BARMUVADA FEEDER",
 "CHAULAJ FEEDER-GAMIJ-3","FINAV FEEEDER","FUDAL MATA FEEDER","GAYATRI FEEDER",
 "GINJAR FEEDER","HALDARWAS FEEDER-GAMIJ-3","HALDARWAS FEEDER-GAMIJ-4",
 "KALPSAR FEEDER","SATRUNDA FEEDER-GAMIJ-3","SATRUNDA FEEDER-GAMIJ-4",
 "SIHUNJ FEEDER","VANSOLI FEEDER",
 "PREKSHA BHARTI INFOCITY FEEDER","TP-44 FEEDER","ZUNDAL AG FEEDER"
]
};
let feeders=[], activeFeeders=[];
let lastResumeMsg="";

/* ================= LOGIN ================= */
function login(){
  const u=lg_user.value.trim();
  const p=lg_pass.value.trim();
  if(!u||!p){ loginMsg.innerText="Enter credentials"; return; }

  // SIMPLE DEMO AUTH (change as needed)
  if(u==="admin" && p==="admin123"){
    USER="ADMIN"; ROLE="ADMIN"; INSTALL="ALL";
  }else{
    USER=u.toUpperCase(); ROLE="USER"; INSTALL="AREA-IV";
  }

  loginBox.classList.add("hidden");
  mainBox.classList.remove("hidden");
  welcome.innerText=`Welcome ${USER} (${INSTALL})`;

  if(ROLE==="ADMIN") planBtn.classList.remove("hidden");

  loadCSV();
}

/* ================= CSV LOAD ================= */
function loadCSV(){
  fetch(CSV_URL)
  .then(r=>r.text())
  .then(t=>{
    const rows=parseCSV(t);
    feeders=[];
    activeFeeders=[];
    rows.slice(1).forEach(r=>{
      if(r[0]) feeders.push(r[0]);
      if(r[5]==="SHUTDOWN") activeFeeders.push(r[0]);
    });
    refreshLists();
  });
}

function parseCSV(csv){
  return csv.split(/\r?\n/).map(row=>{
    const res=[]; let cur="",q=false;
    for(let c of row){
      if(c=='"') q=!q;
      else if(c=="," && !q){res.push(cur);cur="";}
      else cur+=c;
    }
    res.push(cur);
    return res.map(x=>x.replace(/"/g,"").trim());
  });
}

/* ================= UI ================= */
function refreshLists(){
  activeList.innerHTML="";
  activeFeeders.forEach(f=>{
    activeList.innerHTML+=`<div>${f}</div>`;
  });

  sd_feeder.innerHTML="<option value=''>Select Feeder</option>";
  rs_feeder.innerHTML="<option value=''>Select Feeder</option>";
  feeders.forEach(f=>{
    sd_feeder.innerHTML+=`<option>${f}</option>`;
  });
  activeFeeders.forEach(f=>{
    rs_feeder.innerHTML+=`<option>${f}</option>`;
  });
}

function openShutdown(){
  mainBox.classList.add("hidden");
  shutdownBox.classList.remove("hidden");
}

function openResume(){
  mainBox.classList.add("hidden");
  resumeBox.classList.remove("hidden");
}

function back(){
  shutdownBox.classList.add("hidden");
  resumeBox.classList.add("hidden");
  mainBox.classList.remove("hidden");
}

/* ================= VALIDATION ================= */
function hasSpecialChar(t){
  return !/^[A-Z0-9 .\-\/]+$/.test(t);
}

/* ================= SUBMIT SHUTDOWN ================= */
function submitShutdown(){
  const f=sd_feeder.value;
  if(!f){ sd_msg.innerText="Select feeder"; return; }
  if(activeFeeders.includes(f)){
    sd_msg.innerText="Feeder already in shutdown";
    return;
  }

  const data=new URLSearchParams({
    action:"shutdown",
    feeder:f,
    time:sd_time.value.replace("T"," "),
    type:sd_type.value,
    info:sd_info.value.toUpperCase(),
    entryBy:USER,
    installation:INSTALL
  });

  fetch(SCRIPT_URL,{method:"POST",body:data})
  .then(r=>r.text())
  .then(t=>{
    sd_msg.innerText=t;
    loadCSV();
  });
}

/* ================= SUBMIT RESUME ================= */
function submitResume(){
  if(isNaN(rs_loss.value)||isNaN(rs_dg.value)){
    rs_msg.innerText="Loss and DG must be numeric";
    return;
  }

  const data=new URLSearchParams({
    action:"resume",
    feeder:rs_feeder.value,
    time:rs_time.value.replace("T"," "),
    loss:rs_loss.value,
    dg:rs_dg.value,
    rem:rs_rem.value.toUpperCase(),
    entryBy:USER
  });

  fetch(SCRIPT_URL,{method:"POST",body:data})
  .then(r=>r.text())
  .then(t=>{
    rs_msg.innerText=t;
    lastResumeMsg=t;
    resumeShareBtn.classList.remove("hidden");
    loadCSV();
  });
}

/* ================= WHATSAPP ================= */
function shareResumeWhatsApp(){
  const msg=encodeURIComponent(lastResumeMsg);
  window.open("https://wa.me/?text="+msg,"_blank");
}
</script>

</body>
</html>
