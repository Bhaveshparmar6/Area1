<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>POWER SHUTDOWN MANAGEMENT APP - AREA-IV</title>

<style>
body{
  font-family:"Segoe UI",Roboto,Arial;
  background:#f1f3f6;
  margin:0;
}
header{
  background:#1f3a5f;
  color:#fff;
  padding:14px 18px;
  font-size:18px;
  font-weight:600;
}
.card{
  background:#fff;
  margin:14px;
  padding:16px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}
.hidden{display:none;}
input,select,textarea{
  width:100%;
  padding:8px;
  margin:6px 0;
  border-radius:4px;
  border:1px solid #ccc;
  font-size:14px;
}
button{
  padding:10px 14px;
  border:none;
  border-radius:5px;
  cursor:pointer;
  font-weight:600;
  margin-top:8px;
}
.btn-login{background:#1f3a5f;color:#fff;width:100%;}
.btn-shutdown{background:#c0392b;color:#fff;}
.btn-resume{background:#27ae60;color:#fff;}
.btn-back{background:#7f8c8d;color:#fff;}
.msg{margin-top:8px;font-weight:600;}
.list{margin-top:8px;font-size:14px;}
.list div{padding:6px;border-bottom:1px solid #ddd;}
</style>
</head>

<body>

<header>POWER SHUTDOWN MANAGEMENT APP - AREA-IV</header>

<!-- LOGIN -->
<div class="card" id="loginBox">
  <h3>Login</h3>
  <input id="lg_user" placeholder="Username">
  <input id="lg_pass" type="password" placeholder="Password">
  <button class="btn-login" onclick="login()">LOGIN</button>
  <div class="msg" id="loginMsg"></div>
</div>

<!-- MAIN -->
<div class="card hidden" id="mainBox">
  <h3 id="welcome"></h3>
  <button class="btn-shutdown" onclick="openShutdown()">Shutdown Entry</button>
  <button class="btn-resume" onclick="openResume()">Resume Entry</button>
  <button class="btn-login hidden" id="planBtn">Plan Shutdown (ADMIN)</button>

  <h4>Active Shutdowns</h4>
  <div class="list" id="activeList"></div>
</div>

<!-- SHUTDOWN -->
<div class="card hidden" id="shutdownBox">
  <h3>Shutdown Entry</h3>
  <select id="sd_feeder"></select>
  <input type="datetime-local" id="sd_time">
  <select id="sd_type">
    <option>UNPLAN</option>
    <option>PLAN</option>
  </select>
  <textarea id="sd_info" placeholder="Information"></textarea>
  <button class="btn-shutdown" onclick="submitShutdown()">Submit Shutdown</button>
  <button class="btn-back" onclick="back()">Back</button>
  <div class="msg" id="sd_msg"></div>
</div>

<!-- RESUME -->
<div class="card hidden" id="resumeBox">
  <h3>Resume Entry</h3>
  <select id="rs_feeder"></select>
  <input type="datetime-local" id="rs_time">
  <input id="rs_loss" placeholder="Production Loss">
  <input id="rs_dg" placeholder="DG Deployed">
  <textarea id="rs_rem" placeholder="Remarks"></textarea>
  <button class="btn-resume" onclick="submitResume()">Submit Resume</button>
  <button id="resumeShareBtn" class="btn-resume hidden"
    onclick="shareResumeWhatsApp()">üì≤ Share Resume</button>
  <button class="btn-back" onclick="back()">Back</button>
  <div class="msg" id="rs_msg"></div>
</div>

<script>
/* ================= CONFIG ================= */
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbyOHQzRGiI0ql-Tlzbm9BhtFfE12YXEIy9TCfP1_uzdtbn4ltTcjBWJwnpWOF1-u08tkA/exec";
const CSV_URL="https://docs.google.com/spreadsheets/d/1NLMcoIjlo5elmrALUXPfvGOEqToS8tFPfGThRZ8maiU/export?format=csv";
const USERS=[
 {u:"121318",p:"admin123",n:"SYSTEM ADMIN",i:"ALL",admin:true},
 {u:"95606",p:"*ongc123",n:"SUDHIR SINGH",i:"ALL",admin:true},
 {u:"95843",p:"*ongc123",n:"DIPAK MEDAK",i:"ALL",admin:true},
 {u:"82653",p:"*ongc123",n:"SHANTILAL RATHWA",i:"ALL",admin:true},
 {u:"82051",p:"*ongc123",n:"HEMENDRA KUMAR",i:"ALL",admin:true},
 {u:"124569",p:"1234",n:"KULDIP KHAROLIA",i:"LIMBODARA-GGS-1"},
 {u:"133668",p:"1234",n:"DIPAK MAURYA",i:"LIMBODARA-GGS-1"},
 {u:"124470",p:"1234",n:"SANDESH BHARDWAJ",i:"LIMBODARA-GGS-2"},
 {u:"135597",p:"1234",n:"KUNAL RANJAN",i:"LIMBODARA-GGS-2"},
 {u:"139938",p:"1234",n:"HAREKRISHNA",i:"LIMBODARA-GGS-2"},
 {u:"125223",p:"1234",n:"SUKUMAR LAHA",i:"GAMIJ-GGS-1"},
 {u:"139646",p:"1234",n:"RAVI KUMAR SHARMA",i:"GAMIJ-GGS-1"},
 {u:"137317",p:"1234",n:"SONUKUMAR SINGH",i:"GAMIJ-GGS-1"},
 {u:"121028",p:"1234",n:"ABHISHEK PATEL",i:"GAMIJ-GGS-2"},
 {u:"133181",p:"1234",n:"KETUL PATEL",i:"GAMIJ-GGS-2"},
 {u:"123310",p:"1234",n:"DHEERENDRA SINGH",i:"GAMIJ-GGS-3"},
 {u:"133643",p:"1234",n:"ASHUTOSH KUMAR SINGH",i:"GAMIJ-GGS-3"},
 {u:"135515",p:"1234",n:"ADITYA ARYA",i:"GAMIJ-GGS-3"},
 {u:"130594",p:"1234",n:"MAHESH GAJJAR",i:"MOTERA-GGS"}
];

const FEEDERS={
 "LIMBODARA-GGS-1":["AKASH CERAMIC FEEDER","ITLA ONGC FEEDER-LG1","MANSA CITY FEEDER","MANSA CIVIL FEEDER"],
"LIMBODARA-GGS-2":["ITLA ONGC FEEDER-LG2","KIRTIDHAM FEEDER","LISA FEEDER","MAHAKALI FEEDER","MUBARAKPUR FEEDER","NETRA FEEDER","ROYAL FEEDER","TIRUPATI FEEDER","VARDAYINI FEEDER"],
"GAMIJ-GGS-1":["BAHIYAL ONGC FEEDER","RAM FEEDER-GAMIJ-1","SOMNATH JGY FEEDER","NAYRA JGY FEEDER","VASNA RATHOD FEEDER"],
"GAMIJ-GGS-2":["BADARPUR FEEDER","CHAULAJ FEEDER-GAMIJ-2","GADWEL FEEDER","KASHTABHANJAN FEEDER","RAM FEEDR-GAMIJ-2"],
"GAMIJ-GGS-3":["BADARPUR FEEDER","CHAULAJ FFEDER-GAMIJ-2","GADWEL FEEDER","KASHTABHANJAN FEEDER","RAM FEEDR-GAMIJ-2","BARMUVADA FEEDER","CHAULAJ FEEDER-GAMIJ-3","FINAV FEEEDER","FUDAL MATA FEEDER","GAYATRI FEEDER","GINJAR FEEDER","HALDARWAS FEEDER-GAMIJ-3","HALDARWAS FEEDER-GAMIJ-4","KALPSAR FEEDER","SATRUNDA FEEDER-GAMIJ-3","SATRUNDA FEEDER-GAMIJ-4","SIHUNJ FEEDER","VANSOLI FEEDER"],
"MOTERA-GGS":["PREKSHA BHARTI INFOCITY FEEDER","TP-44 FEEDER","ZUNDAL AG FEEDER"],
"ALL":["AKASH CERAMIC FEEDER","ITLA ONGC FEEDER-LG1","MANSA CITY FEEDER","MANSA CIVIL FEEDER",
 "ITLA ONGC FEEDER-LG2","KIRTIDHAM FEEDER","LISA FEEDER","MAHAKALI FEEDER",
 "MUBARAKPUR FEEDER","NETRA FEEDER","ROYAL FEEDER","TIRUPATI FEEDER","VARDAYINI FEEDER",
 "BAHIYAL ONGC FEEDER","RAM FEEDER-GAMIJ-1","SOMNATH JGY FEEDER","NAYRA JGY FEEDER",
 "VASNA RATHOD FEEDER","BADARPUR FEEDER","CHAULAJ FFEDER-GAMIJ-2","GADWEL FEEDER",
 "KASHTABHANJAN FEEDER","RAM FEEDR-GAMIJ-2","BARMUVADA FEEDER",
 "CHAULAJ FEEDER-GAMIJ-3","FINAV FEEEDER","FUDAL MATA FEEDER","GAYATRI FEEDER",
 "GINJAR FEEDER","HALDARWAS FEEDER-GAMIJ-3","HALDARWAS FEEDER-GAMIJ-4",
 "KALPSAR FEEDER","SATRUNDA FEEDER-GAMIJ-3","SATRUNDA FEEDER-GAMIJ-4",
 "SIHUNJ FEEDER","VANSOLI FEEDER",
 "PREKSHA BHARTI INFOCITY FEEDER","TP-44 FEEDER","ZUNDAL AG FEEDER"
]
};
function login(){
 const u = USERS.find(x =>
   x.u === lg_user.value &&
   x.p === lg_pass.value
 );

 if(!u){
   alert("Invalid Login");
   return;
 }

 CURRENT_USER = u;

 loginBox.classList.add("hidden");
 mainBox.classList.remove("hidden");
 shutdownBox.classList.add("hidden");
 resumeBox.classList.add("hidden");

 populateFeeders();
 loadActiveShutdowns();
}
function populateFeeders(){
 sd_feeder.innerHTML=rs_feeder.innerHTML="";
 (FEEDERS[CURRENT_USER.i]||FEEDERS.ALL).forEach(f=>{
  sd_feeder.innerHTML+=`<option>${f}</option>`;
  rs_feeder.innerHTML+=`<option>${f}</option>`;
 });
}

function loadActiveShutdowns(){
  LAST_SHUTDOWN_TIME = {};
  fetch(CSV_URL + "&t=" + Date.now())
    .then(r => r.text())
    .then(t => {
      const rows = t.split("\n").map(r => r.split(",").map(x => x.replace(/"/g,"").trim()));
      const h = rows.shift().map(x => x.toUpperCase());

      const i = {
        feeder: h.findIndex(x => x.includes("FEEDER")),
        sd:     h.findIndex(x => x.includes("SHUTDOWN")),
        rs:     h.findIndex(x => x.includes("RESUME")),
        inst:   h.findIndex(x => x.includes("INSTALL")),
        type:   h.findIndex(x => x.includes("TYPE"))
      };

      activeShutdowns.innerHTML = "";
      let count = 0;

      rows.forEach(r => {
        const feeder = r[i.feeder];
        const sdTime = r[i.sd];
        const rsTime = r[i.rs];
        const inst   = r[i.inst];
        const type   = r[i.type];

        if (!rsTime || rsTime === "NA") {
          if (!CURRENT_USER.admin && inst !== CURRENT_USER.i) return;

          LAST_SHUTDOWN_TIME[feeder] = sdTime;
          count++;

          activeShutdowns.innerHTML += `
<div class="shutdown-item">
  <div class="shutdown-row">
    <span class="shutdown-label">FEEDER</span>
    <span class="shutdown-value">${feeder}</span>
  </div>
  <div class="shutdown-row">
    <span class="shutdown-label">TYPE</span>
    <span class="shutdown-value">${type}</span>
  </div>
  <div class="shutdown-row">
    <span class="shutdown-label">TIME</span>
    <span class="shutdown-value">${sdTime}</span>
  </div>
  <div class="shutdown-row">
    <span class="shutdown-label">INSTALLATION</span>
    <span class="install-badge">${inst}</span>
  </div>

  <!-- ‚úÖ WHATSAPP SHARE BUTTON -->
  <button style="
    margin-top:10px;
    width:100%;
    background:#25D366;
    color:#fff;
    border:none;
    padding:10px;
    border-radius:10px;
    font-weight:700;
    cursor:pointer;"
    onclick="shareWhatsApp('${feeder}','${type}','${sdTime}','${inst}')">
    üì≤ Share on WhatsApp
  </button>
</div>`;
        }
      });

      if (!count) {
        activeShutdowns.innerHTML =
          `<div class="shutdown-item" style="text-align:center;color:#27ae60;font-weight:700">
            ‚úÖ All FEEDERS ARE HEALTHY
           </div>`;
      }
    });
}

function submitResume(){
 if(!rs_feeder.value||!rs_time.value||!rs_loss.value||!rs_dg.value||!rs_rem.value){
 showMsg("All Resume fields required");
 return;
}

// üö´ Special character validation
if(hasSpecialChar(rs_rem.value)){
 showMsg("‚ùå Do not use special characters");
 return;
}


 if(!LAST_SHUTDOWN_TIME[rs_feeder.value]){
  showMsg("Feeder not found in shutdown");
  return;
 }

 const sd = new Date(LAST_SHUTDOWN_TIME[rs_feeder.value]);
 const rt = new Date(rs_time.value);

 if(rt <= sd){
  showMsg("Resume time must be greater than Shutdown time");
  return;
 }

 fetch(WEBAPP_URL+"?"+new URLSearchParams({
  action:"resume",
  feeder: rs_feeder.value,
  ResumeTime: rs_time.value.replace("T"," "),
  ResumeEntryBy: CURRENT_USER.n,
  TotalProdLoss: rs_loss.value,
  DGDeployed: rs_dg.value,
  Remarks: rs_rem.value
 }), { mode:"no-cors" });

 // ‚úÖ STORE LAST RESUME DATA
 LAST_RESUME_DATA = {
  feeder: rs_feeder.value,
  resumeTime: rs_time.value.replace("T"," "),
  loss: rs_loss.value,
  dg: rs_dg.value,
  reason: rs_rem.value,
  user: CURRENT_USER.n,
  inst: CURRENT_USER.i
 };

 // ‚úÖ SHOW WHATSAPP BUTTON
 document.getElementById("resumeShareBtn").classList.remove("hidden");

 showMsg("Resume Submitted");
}
function hasSpecialChar(text){
  // allowed: letters, numbers, space, - and /
  const regex = /^[a-zA-Z0-9 \-/]+$/;
  return !regex.test(text);
}
function submitShutdown(){
 if(!sd_feeder.value||!sd_time.value||!sd_type.value||!sd_info.value){
 showMsg("All Shutdown fields required");
 return;
}

// üö´ Special character validation
if(hasSpecialChar(sd_info.value)){
 showMsg("‚ùå Do not use special characters");
 return;
}


 // üö´ Prevent duplicate shutdown
 if(LAST_SHUTDOWN_TIME[sd_feeder.value]){
  showMsg("Feeder already in shutdown");
  return;
 }

 fetch(WEBAPP_URL+"?"+new URLSearchParams({
  action:"shutdown",
  feeder:sd_feeder.value,
  ShutdownTime:sd_time.value.replace("T"," "),
  ShutdownType:sd_type.value,
  Information: sd_info.value.toUpperCase(),
  ShutdownEntryBy: CURRENT_USER.n,
  Installation: CURRENT_USER.i
 }),{mode:"no-cors"});

 showMsg("Shutdown Submitted");
 backToMain();
}

function openShutdown(){mainBox.classList.add("hidden");shutdownBox.classList.remove("hidden")}
function openResume(){
 mainBox.classList.add("hidden");
 resumeBox.classList.remove("hidden");

 // hide initially, will show only after submit
 document.getElementById("resumeShareBtn").classList.add("hidden");
}
function backToMain(){
 shutdownBox.classList.add("hidden");
 resumeBox.classList.add("hidden");
 mainBox.classList.remove("hidden");
 loadActiveShutdowns();
}
function showMsg(t){msg.innerText=t;setTimeout(()=>msg.innerText="",3000)}
setInterval(loadActiveShutdowns,30000);
function shareWhatsApp(feeder, type, time, inst){
 const msg =
  "‚ö° *POWER SHUTDOWN ALERT* ‚ö°\n\n" +
  "üîå *Feeder:* " + feeder + "\n" +
  "üìù *Type:* " + type + "\n" +
  "‚è∞ *Shutdown Time:* " + time + "\n" +
  "üè≠ *Installation:* " + inst + "\n\n" +
  "‚Äî Area-IV Power Shutdown App";

 const url = "https://wa.me/?text=" + encodeURIComponent(msg);
 window.open(url, "_blank");
}
function shareResumeWhatsApp(){
 if(!LAST_RESUME_DATA){
















  showMsg("No Resume Data Found");
  return;
 }

 const d = LAST_RESUME_DATA;

 const msg =
  "‚úÖ *POWER RESUME UPDATE* ‚úÖ\n\n" +
  "üîå *Feeder:* " + d.feeder + "\n" +
  "‚è∞ *Resume Time:* " + d.resumeTime + "\n" +
  "‚öôÔ∏è *DG Deployed:* " + d.dg + "\n" +
  "üìù *Reason:* " + d.reason + "\n" +
  "üë§ *Updated By:* " + d.user + "\n" +
  "üè≠ *Installation:* " + d.inst + "\n\n" +
  "‚Äî Area-IV Power Shutdown App";

 window.open(
  "https://wa.me/?text=" + encodeURIComponent(msg),
  "_blank"
 );
}
// üö´ Live blocking of special characters
document.querySelectorAll("textarea, input[type=text]").forEach(el=>{
 el.addEventListener("input",()=>{
  el.value = el.value.replace(/[^a-zA-Z0-9 \-/]/g,"");
 });
});
</script>
</body>
</html>
